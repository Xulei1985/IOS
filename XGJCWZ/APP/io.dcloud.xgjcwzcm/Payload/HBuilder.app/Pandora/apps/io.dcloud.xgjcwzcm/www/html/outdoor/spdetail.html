<!doctype html>
<html>

	<head>
		<meta charset="UTF-8">
		<title>加班详情</title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<link href="../../js/mui/css/mui.min.css" rel="stylesheet" />
		<link rel="stylesheet" href="../../style/weui.css" />
		<link rel="stylesheet" href="../../fonts/iconfont.css" />
		<link rel="stylesheet" href="../../style/style.css" />
		<script src="../../js/flexible.js"></script>
	</head>

	<body ontouchstart>
		<input type="hidden" id="keyId" name="keyId" />
		<header class="pui-header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="margin-top: 12px;"></a>
			<h1 class="pui-title">审批详情</h1>
		</header>
		<div class="ui-wrap">
			<div class="weui-cells weui-info-cells">
				<div class="weui-cell">
					<div class="weui-cell__bd">
						<div class="label-text">申请部门</div>
					</div>
					<div class="weui-cell__ft" id="deptName"></div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__bd">
						<div class="label-text">申请人数</div>
					</div>
					<div class="weui-cell__ft" id="numb"></div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__bd">
						<div class="label-text">申请时间</div>
					</div>
					<div class="weui-cell__ft" id="startTime"></div>
				</div>
				<div class="weui-cell">
					<div class="weui-cell__bd">
						<div class="label-text">申请状态</div>
					</div>
					<div class="weui-cell__ft" id="auditStatus"></div>
				</div>
			</div>
		</div>
		<div id="checkbutton">
			<div class="button-group">
				<button class="weui-btn weui-btn_default" id="tongyi">同意</button>
				<button class="weui-btn weui-btn_danger" id="butongyi">不同意</button>
			</div>
		</div>
		<div id="refreshContainer" hidden="hidden"></div>
		<div>
			<div id="item1" class="mui-control-content mui-active">
				<div id="scroll" class="mui-scroll-wrapper">
					<div class="mui-scroll">
						<ul id="overtimelist" class="mui-table-view">
						</ul>
					</div>
				</div>
			</div>
		</div>
		<script type="text/html" id="template">
			<%for(var i=0;i<content.length;i++){%>
			<div class="weui-cell">
				<div class="weui-cell__bd">
					<div class="qk-header justify">
						<div class="qk-text">申请人：<%=content[i].userName%></div>
						<div class="qk-text">加班理由：<%=content[i].overtimeReason%></div>
					</div>
				</div>
			</div>
			<%}%>
		</script>
		<script type="text/javascript" src="../../js/plugins/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="../../js/plugins/zepto.min.js"></script>
		<script type="text/javascript" src="../../js/mui/js/mui.js"></script>
		<script type="text/javascript" src="../../js/util.js"></script>
		<script type="text/javascript" src="../../js/plugins/template.js"></script>
		<script type="text/javascript" src="../../js/plugins/mainPage.js"></script>
		<script type="text/javascript" src="../../js/plugins/update.js"></script>
		<script src="../../js/mui/js/mui.min.js"></script>
		<script type="text/javascript">
			var arr = [];
			//mui初始化
			/*mui.init({
				swipeBack: true //启用右滑关闭功能
			});*/
			document.getElementById("tongyi").addEventListener('click', function(e) {
				//e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
				setShenpi("2", e.value);
				// mui.prompt('请输入审批理由：', function(e) {
				// 	if(e.index == 1) {
				// 		
				// 	}
				// })
			});
			document.getElementById("butongyi").addEventListener('click', function(e) {
				//e.detail.gesture.preventDefault(); //修复iOS 8.x平台存在的bug，使用plus.nativeUI.prompt会造成输入法闪一下又没了
				mui.prompt('请输入审批理由：', function(e) {
					if (e.index == 1) {
						setShenpi("3", e.value);
					}
				})
			});

			function setShenpi(resultInt, reason) {
				// alert(arr)
				var data = {
					auditStatus: resultInt,
					auditReason: reason
				}
				util.ajax({
					type: 'post',
					url: '/api/auditAllDept/' + arr,
					dataType: 'json',
					data: JSON.stringify(data),
					contentType: "application/json",
					success: function(data) {
						mui.toast("审批成功");
						Page.backInit();
					}
				});
			}
			var Page = {
				init: function() {
					var self = plus.webview.currentWebview();
					var a = 0;
					$("#keyId").val(self.keyId);
					$("#deptName").html(self.deptName);
					$("#numb").html(self.numb);
					$("#startTime").html(self.startTime);
					$("#auditStatus").html(self.auditStatus);
					if (self.auditStatus == "审批通过" || self.auditStatus == "审批未通过") {
						$("#checkbutton").html(
							"<div class=\"button-qk-area\"><button class=\"weui-btn weui-btn_block weui-btn_default\">已审</button></div>"
						);
					}
					if (self.auditStatus == "待审批") {
						a = 1
					} else if (self.auditStatus == "审批通过") {
						a = 2
					} else if (self.auditStatus == "审批未通过") {
						a = 3
					} else {
						a = 0
					}
					var data = {
						size: 10,
						lastChangeLoginName: self.startTime,
						deptName: self.keyId,
						auditStatus: a
					}
					util.pullRefresh({
						source: function() {
							return "/api/queryDeptStatusList";
						},
						container: "#refreshContainer",
						domContainer: function() {
							return "#overtimelist";
						},
						resultHandler: function(data) {
							if (data.content) {
								$.each(data.content, function() {
									arr.push(this.overId)
								})
							}
							return data;
						},
						params: data,
						down: true,
						up: true,
						template: function() {
							return "template";
						}
					});
				},
				backInit: function() {
					var wvB = plus.webview.currentWebview(); //获取当前窗口的WebviewObject对象，即B  
					var wvA = wvB.opener(); //获取当前窗口的创建者，即A  
					wvA.evalJS("Page.backInit()"); //执行父窗口中的方法  A中的showAG方法  
					wvB.close();
				},
			};
			mui.plusReady(function() {
				Page.init();
				util.appBack();
			});
		</script>
	</body>

</html>
