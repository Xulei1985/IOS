<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>更多</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../js/mui/css/mui.css" type="text/css" rel="stylesheet" />
		<link rel="stylesheet" href="../style/weui.css" />
		<link rel="stylesheet" href="../fonts/iconfont.css" />
		<link rel="stylesheet" href="../style/style.css" />
		<script src="../js/flexible.js"></script>
		<script src="../js/jquery.min.js"></script>
		<script src="../js/common.js"></script>
		<script type="text/javascript" src="../js/plugins/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="../js/mui/js/mui.js"></script>
		<script type="text/javascript" src="../js/plugins/zepto.min.js"></script>
		<script type="text/javascript" src="../js/plugins/template.js"></script>
		<script type="text/javascript" src="../js/util.js"></script>
		<script type="text/javascript" src="../js/codescan/jquery.code-scan.js"></script>
		
	</head>
	<body ontouchstart>
		<header class="pui-header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="margin-top: 12px;" onclick="beforeback()"></a>
			<h1 class="pui-title">更多</h1>
			<input type="hidden" id="scanCode" />
		</header>
		<div class="ui-wrap">
			<div id="refreshContainer" hidden="hidden"></div>
			<div class="tab-content">
				<div class="tab-pane" id="approveList">
				</div>
			</div>
		</div>
		<script type="text/html" id="template">
			<%for(var i=0;i<data.length;i++){%>
			<a href="javascript:;" class="weui-cell weui-cell_access" onclick="goToAudit(
			'<%=data[i].id%>','<%=data[i].orderNo%>','<%=data[i].holderName%>','<%=data[i].holderOrgName%>',
			'<%=data[i].materialTypeCode%>','<%=data[i].materialTypeName%>','<%=data[i].driverName%>',
			'<%=data[i].driverCardTypeName%>','<%=data[i].driverCardId%>','<%=data[i].license%>',
			'<%=data[i].status%>','<%=data[i].warehouseName%>','<%=data[i].reason%>',
			'<%=data[i].applyUserName%>','<%=data[i].applyTime%>')">
				<div class="weui-cell__bd">
					<span class="qk-status"><%=data[i].status%></span>
					<span class="card-info">单号:<%=data[i].orderNo%></span>
					<p class="time">申请时间:<%=data[i].applyTime%></p>
				</div><div class="weui-cell__ft"></div>
			</a>
			<%}%>
		</script>
		<script type="text/javascript">

			function goToAudit(outdoorId, orderNo,holderName,holderOrgName,materialTypeCode,materialTypeName,driverName,driverCardTypeName,
			driverCardId,license,status,warehouseName,reason,applyUserName,applyTime) {
				if(status === '待结单'){
					mui.openWindow({
						url: "./outdoor/end.html",
						id: "outdoorEnd",
						extras: {
							data: outdoorId
						}
					});
					// mui.openWindow({
					// 	// 添加if判断,根据不同状态跳转不同页面
					// 	url: './outdoor/account.html',
					// 	id: 'account',
					// 	extras: {
					// 		outdoorId: outdoorId,
					// 		orderNo: orderNo,
					// 		holderName: holderName,
					// 		holderOrgName: holderOrgName,
					// 		materialTypeCode: materialTypeCode,
					// 		materialTypeName: materialTypeName,
					// 		driverName: driverName,
					// 		driverCardTypeName: driverCardTypeName,
					// 		driverCardId: driverCardId,
					// 		license: license,
					// 		status: status,
					// 		warehouseName: warehouseName,
					// 		reason: reason,
					// 		applyUserName: applyUserName,
					// 		applyTime: applyTime
					// 	}
					// });
				}else{
					// mui.openWindow({
					// 	// 添加if判断,根据不同状态跳转不同页面
					// 	url: './outdoor/audit.html',
					// 	id: 'audit',
					// 	extras: {
					// 		outdoorId: outdoorId,
					// 		orderNo: orderNo,
					// 		holderName: holderName,
					// 		holderOrgName: holderOrgName,
					// 		materialTypeCode: materialTypeCode,
					// 		materialTypeName: materialTypeName,
					// 		driverName: driverName,
					// 		driverCardTypeName: driverCardTypeName,
					// 		driverCardId: driverCardId,
					// 		license: license,
					// 		status: status,
					// 		warehouseName: warehouseName,
					// 		reason: reason,
					// 		applyUserName: applyUserName,
					// 		applyTime: applyTime
					// 	}
					// });
					mui.openWindow({
						url: './outdoor/approve.html',
						id: "approve",
						extras: {
							data: outdoorId
						}
					})
				}
			};
			              
			var flag = true;
			var Page = {
				init: function() {
						var datas = new Object();
						datas.pageIndex = 1;
						datas.pageSize = 2;  
						datas.criteria = {};
						util.pullRefresh({
							source: "/outdoor/auditList",
							container: "#refreshContainer",
							domContainer: "#approveList",
							type:"POST", 
							params:datas,
							resultHandler: function(data) {
								return data;
							},
							down: true,
							up: true,
							template: "template"
						}) 
				},
				// 重新加载时使用
				// 重新加载时使用
				reload: function() {
					this.backInit();
				},
				backInit: function() {
					util.pullRefreshRequest("down");
				},
				back: function() {
					var wvB = plus.webview.currentWebview(); //获取当前窗口的WebviewObject对象，即B  
					var wvA = wvB.opener(); //获取当前窗口的创建者，即A  
					wvA.evalJS("Page.reload()"); //执行父窗口中的方法  A中的showAG方法  
					wvB.close();
				},
				beforeback: function() {　　　　
                   var list = plus.webview.currentWebview().opener();　　　　
                   //refresh是A页面自定义事件
                   mui.fire(list, 'refresh');
                   //返回true,继续页面关闭逻辑
                   return true;
                }
			}
			
		
			mui.plusReady(function() {
				Page.init();
				
				//监听扫码
				$("#scanCode").codeScan({
					cssClass:"container",
					onScan:function(code){ 
						var datas = new Object();
						datas.criteria.orderNo = code;
						var tempObj = new Object();
						util.ajax({
							type: 'post',
							url:  "/outdoor/query",
							dataType: 'json',
							data: datas,
							contentType: "application/json",
							success: function(data) {
								tempObj = data.data[0]
								mui.toast("操作成功");
								Page.backInit();
							},
							error: function(xhr, type, errorThrown) {
								var temp = JSON.parse(xhr.response)
								mui.toast(temp.message);
							}
						});
						//code为出门单号
						goToDetail(tempObj.orderNo,tempObj.applyTime,tempObj.holderName,tempObj.driverName,tempObj.driverCardId);
					}
				});
			
			
			});
			
			
			
			
		</script>
	</body>

</html>
