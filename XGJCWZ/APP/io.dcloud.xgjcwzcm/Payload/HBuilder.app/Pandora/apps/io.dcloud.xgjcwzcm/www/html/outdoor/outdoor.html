<!doctype html>
<html>

	<head>
		<meta charset="utf-8">
		<title></title>
		<meta name="viewport" content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no" />
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../js/mui/css/mui.css" type="text/css" rel="stylesheet" />
		<link rel="stylesheet" type="text/css" href="../../js/mui/css/mui.picker.min.css" />
		<link rel="stylesheet" href="../../style/weui.css" />
		<link rel="stylesheet" href="../../fonts/iconfont.css" />
		<link rel="stylesheet" href="../../style/style.css" />
		<script src="../../js/flexible.js"></script>
	</head>

	<body ontouchstart>
		<header class="pui-header">
			<a class="mui-action-back mui-icon mui-icon-left-nav mui-pull-left" style="margin-top: 12px;"></a>
			<h1 class="pui-title">我的加班</h1>
		</header>
		<div class="ui-wrap" style="background-color: #fff;">
			<form class="mui-input-group" style="width: 100%; border-bottom: 0;">
				<div class="ui-wrap">
					<div class="qk-form">

						<div class="weui-cell weui-cell_access" style="height: 60px;">
							<div class="qk-label"><span class="text-red">*</span> 加班原因</div>
							<div class="weui-cell__bd">
								<select id="select_overtimeReason" dir="rtl" style="width: 100%;margin-top: 16px;">
								</select>
							</div>
							<div class="weui-cell__ft"></div>
						</div>
						<div class="weui-cell weui-cell_access" style="height: 60px;">
							<div class="qk-label"><span class="text-red">*</span> 加班人员</div>
							<div class="weui-cell__bd">
								<select id="select_deptUser" dir="rtl" multiple="multiple" style=" margin-bottom: 0;font-size:16px;width: 100%;" size="1">
								</select>
							</div>
							<div class="weui-cell__ft"></div>
						</div>
						<div class="weui-cell weui-cell_access">
							<div class="qk-label"><span class="text-red">*</span> 加班时间</div>
							<div class="weui-cell__bd">
								<button id="qishiri" data-options='{}' class="mui-btn" style="width: 100%;border: 0; height: 30px;margin-right: -20px;text-align: right;"></button>
							</div>
							<div class="weui-cell__ft"></div>
						</div>
						<div class="weui-cell">
							<div class="qk-label"><span class="text-red">*</span> 加班时长</div>
							<div class="weui-cell__bd">
								<input type="text" id="totalTime" class="weui-input" style="color: #000000;font-size: 16px;"></input>
							</div>
							<div class="weui-cell__ft">天</div>
						</div>
						<div class="weui-cell">
						</div>
					</div>
				</div>
				<div class="button-qk-area">
					<button class="weui-btn weui-btn_block weui-btn_default" type="button" onclick="Page.submitForm();">提交</button>
				</div>
			</form>
		</div>
		<script type="text/javascript" src="../../js/plugins/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="../../js/plugins/zepto.min.js"></script>
		<script type="text/javascript" src="../../js/mui/js/mui.js"></script>
		<script type="text/javascript" src="../../js/util.js"></script>
		<script type="text/javascript" src="../../js/mui/js/mui.picker.min.js"></script>
		<script type="text/javascript">
			var qingjiaType, postType, select_deptUser;
			var Page = {
				init: function() {
					var userid = util.getLoginInfo().user.userId; //获取登录人的id
					$("#qishiri").on('tap', function() {
						var optionsJson = this.getAttribute('data-options') || '{}';
						//var options = JSON.parse(optionsJson);
						var options = {
							type: "date"
						};
						var picker = new mui.DtPicker(options);
						var id = this.getAttribute('id');
						picker.show(function(rs) {
							$("#" + id).html(rs.text)
							picker.dispose();
							$("#totalTime").val(1);
						});

					});
					qingjiaType = new mui.PopPicker();
					var data = {

						dictName: "over_time_reason"
					}

					util.ajax({
						async: false,
						type: 'get',
						url: '/api/dictDetailForSelect',
						data: data,
						success: function(res) {

							$.each(res, function(index, item) {
								$("#select_overtimeReason").append("<option value='" + item.value + "'>" + item.label + "</option>");
							})
						},
					});
					//查询人员是否有段长权限,如果有可以选择本部门人员,如果没有段长权限只能选择自己
					select_deptUser = new mui.PopPicker();
					util.ajax({
						type: 'get',
						url: '/api/app/queryByPermission',
						data: {
							username: util.getLoginInfo().user.username,
						},
						success: function(data) {
							if (data.roles.length > 0) {
								var flag = false;
								$.each(data.roles, function(index, row) {
									if (row.name == "段长") {
										flag = true;
									}
								})
								if (flag) {
									util.ajax({
										type: 'get',
										url: '/api/user/queryByDept',
										data: {
											'dept.name': util.getLoginInfo().user.dept
										},
										success: function(res) {
											$.each(res, function(index, item) {
												$("#select_deptUser").append("<option style='margin-top:2%;' value='" + item.id + "'>" + item.username +
													"</option>");
											})
										},
									});
								} else {
									$("#select_deptUser").append("<option style='margin-top:2%;' value='" + data.id + "' selected>" + data.username +
										"</option>");
								}
							} else {
								$("#select_deptUser").append("<option style='margin-top:2%;' value='" + data.id + "' selected>" + data.username +
									"</option>");
							}
							// })
						},
					});

				},
				numberCheck: function(num) {
					var str = num;
					var len1 = str.substr(0, 1);
					var len2 = str.substr(1, 1);
					//如果第一位是0，第二位不是点，就用数字把点替换掉
					if (str.length > 1 && len1 == 0 && len2 != ".") {
						str = str.substr(1, 1);
					}
					//第一位不能是.
					if (len1 == ".") {
						str = "";
					}
					//限制只能输入一个小数点
					if (str.indexOf(".") != -1) {
						var str_ = str.substr(str.indexOf(".") + 1);
						if (str_.indexOf(".") != -1) {
							str = str.substr(0, str.indexOf(".") + str_.indexOf(".") + 1);
						}
					}
					//正则替换，保留数字和小数点
					str = str.replace(/[^\d^\.]+/g, '')
					$("#totalTime").val(str);
				},

				back: function() {
					var wvB = plus.webview.currentWebview(); //获取当前窗口的WebviewObject对象，即B  
					var wvA = wvB.opener(); //获取当前窗口的创建者，即A  
					wvA.evalJS("Page.reload()"); //执行父窗口中的方法  A中的showAG方法  
					wvB.close();
				},
				submitForm: function() {
					if ($("#select_overtimeReason").val() == null) {
						mui.toast('请填写加班原因', {
							duration: 'long',
							/*duration：持续显示时间，short：2000ms（默认）, long(3500ms)*/
							type: 'div' /* 是否使用h5绘制的对话框 */
						})
						return;
					}
					if ($("#select_deptUser").val() == null) {
						mui.alert("请选择就餐人员！");
						return;
					}
					if ($("#qishiri").html() == "") {
						mui.toast('加班时间不能为空', {
							duration: 'long',
							/*duration：持续显示时间，short：2000ms（默认）, long(3500ms)*/
							type: 'div' /* 是否使用h5绘制的对话框 */
						})
						return;
					}
					if ($("#totalTime").val() == "") {
						mui.toast('加班时长不能为空', {
							duration: 'long',
							/*duration：持续显示时间，short：2000ms（默认）, long(3500ms)*/
							type: 'div' /* 是否使用h5绘制的对话框 */
						})
						return;
					}
					// var ssn = util.getLoginInfo().user.ssn; //获取登录人的id
					var start = $("#qishiri").html();
					//var end=$("#jieshuri").html();
					var totalTime = $("#totalTime").val();
					var timestamp = new Date(start + ' 00:00:00').getTime();
					util.ajax({
						type: 'get',
						url: '/api/overTimeByUser',
						data: {
							startTime: start + ' 00:00:00',
						},
						success: function(res) {
							if (res.length > 0) {
								mui.toast('已提交过加班申请', {
									duration: 'long',
									/*duration：持续显示时间，short：2000ms（默认）, long(3500ms)*/
									type: 'div' /* 是否使用h5绘制的对话框 */
								})
								return;
							} else {
								util.ajax({
									type: 'post',
									url: '/api/app/overTimeAdd',
									dataType: "json",
									contentType: "application/json;charset-UTF-8",
									data: {
										// user: {ssn:ssn},
										userIdList: $("#select_deptUser").val(),
										overtimeReason: $("#select_overtimeReason").val(),
										startTime: util.convertTimeTamp(start),
										//endTime: util.convertTimeTamp(end),
										totalTime: totalTime,
										auditStatus: 1
									},
									success: function(data) {
										mui.toast("提交成功！");
										Page.back();
									},
									error: function() {
										mui.toast("请勿重复提交加班申请!");
									},
									complete: function() {
										util.closeWaiting();
									}
								});
							}

						},
					});


				}
			};
			mui.plusReady(function() {
				Page.init();
			});
		</script>
	</body>

</html>
