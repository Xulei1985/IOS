<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../js/mui/css/mui.css" type="text/css" rel="stylesheet" />
		<link rel="stylesheet" href="../../style/weui.css" />
		<link rel="stylesheet" href="../../fonts/iconfont.css" />
		<link rel="stylesheet" href="../../style/style.css" />
		<script src="../../js/flexible.js"></script>
		<script src="../../js/jquery.min.js"></script>
		<script src="../../js/common.js"></script>
	</head>
	<body ontouchstart>
		<header class="pui-header">
			<h1 class="pui-title">出门证</h1>
			<a href="javascript:void(0);" class="pui-icon pull-right" id="btnApply" style="display:none;" onclick="toApply()">
				<span class="icon-link">添加</span>
			</a>
			<input type="hidden" id="scanCode" />
		</header>
		<div class="ui-wrap">
			<div id="refreshContainer" hidden="hidden"></div>
			<div class="site-tabs">
				<ul class="tab-nav">
					<li class="active"><a href="#outdoorList" id="outdoor" data-toggle="tab">出门证</a></li>
					<li><a href="#approveList" id="approve" data-toggle="tab">审批</a></li>
				</ul>
			</div>
			<div class="tab-content">
				<div class="tab-pane active" id="outdoorList">
				</div>
				<div class="tab-pane" id="approveList">
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../js/plugins/jquery-2.1.1.min.js"></script>
		<script type="text/html" id="template">
			<%for(var i=0;i<data.length;i++){%>
			<a href="javascript:;" class="weui-cell weui-cell_access" onclick="goToDetail('<%=data[i].orderNo%>','<%=data[i].applyTime%>','<%=data[i].holderName%>','<%=data[i].driverName%>','<%=data[i].driverCardId%>',<%=data[i].id%>,<%=data[i].statusValue%>)">
				<div class="weui-cell__bd">
					<span class="qk-status <%=data[i].statusClass%>"><%=data[i].status%></span>
					<span class="card-info">单号:<%=data[i].orderNo%></span>
					<div class="time-div">持物人：<%=data[i].holderName%></div>
					<div class="time-div">持物部门：<%=data[i].holderOrgName%></div>
					<div class="time-div">仓库：<%=data[i].warehouseName%></div>
					<div class="time-div">物资类型：<%=data[i].materialTypeName%></div>
					<div class="time-div">司机姓名：<%=data[i].driverName%></div>
					<div class="time-div">证件类型：<%=data[i].driverCardTypeName%>/<%=data[i].driverCardId%></div>
					<div class="time-div">车牌号：<%=data[i].license%></div>
					<div class="time-div">出厂原因：<%=data[i].reason%></div>
					<div class="time-div">申请人：<%=data[i].applyUserName%></div>
					<div class="time-div">申请时间：<%=data[i].applyTime%></div>
				</div><div class="weui-cell__ft"></div>
			</a>
			<%}%>
		</script>

		<script type="text/html" id="template2">
			<%for(var i=0;i<data.length;i++){%>
			<a href="javascript:;" class="weui-cell weui-cell_access" onclick="goToAudit(
			'<%=data[i].id%>')">
				<div class="weui-cell__bd">
					<span class="qk-status <%=data[i].statusClass%>"><%=data[i].status%></span>
					<span class="card-info">单号:<%=data[i].orderNo%></span>
					<div class="time-div">持物人：<%=data[i].holderName%></div>
					<div class="time-div">持物部门：<%=data[i].holderOrgName%></div>
					<div class="time-div">仓库：<%=data[i].warehouseName%></div>
					<div class="time-div">物资类型：<%=data[i].materialTypeName%></div>
					<div class="time-div">司机姓名：<%=data[i].driverName%></div>
					<div class="time-div">证件类型：<%=data[i].driverCardTypeName%>/<%=data[i].driverCardId%></div>
					<div class="time-div">车牌号：<%=data[i].license%></div>
					<div class="time-div">出厂原因：<%=data[i].reason%></div>
					<div class="time-div">申请人：<%=data[i].applyUserName%></div>
					<div class="time-div">申请时间：<%=data[i].applyTime%></div>
				</div><div class="weui-cell__ft"></div>
			</a>
			<%}%>
		</script>

		<script type="text/javascript" src="../../js/mui/js/mui.js"></script>
		<script type="text/javascript" src="../../js/plugins/zepto.min.js"></script>
		<script type="text/javascript" src="../../js/plugins/template.js"></script>
		<script type="text/javascript" src="../../js/util.js"></script>
		<script type="text/javascript" src="../../js/codescan/jquery.code-scan.js"></script>

		<script type="text/javascript">
			var statusClass = ["status-cancel", "", "", "status-ing", "status-end", "status-cancel", "status-red"];

			function goToAudit(outdoorId, orderNo, holderName, holderOrgName, materialTypeCode, materialTypeName, driverName,
				driverCardTypeName,
				driverCardId, license, status, warehouseName, reason, applyUserName, applyTime) {
				// if (status === '待结单') {
				// 	mui.openWindow({
				// 		// 添加if判断,根据不同状态跳转不同页面
				// 		url: 'account.html',
				// 		id: 'account',
				// 		extras: {
				// 			outdoorId: outdoorId,
				// 			orderNo: orderNo,
				// 			holderName: holderName,
				// 			holderOrgName: holderOrgName,
				// 			materialTypeCode: materialTypeCode,
				// 			materialTypeName: materialTypeName,
				// 			driverName: driverName,
				// 			driverCardTypeName: driverCardTypeName,
				// 			driverCardId: driverCardId,
				// 			license: license,
				// 			status: status,
				// 			warehouseName: warehouseName,
				// 			reason: reason,
				// 			applyUserName: applyUserName,
				// 			applyTime: applyTime
				// 		}
				// 	});
				// } else {
				// 	mui.openWindow({
				// 		// 添加if判断,根据不同状态跳转不同页面
				// 		url: 'audit.html',
				// 		id: 'audit',
				// 		extras: {
				// 			outdoorId: outdoorId,
				// 			orderNo: orderNo,
				// 			holderName: holderName,
				// 			holderOrgName: holderOrgName,
				// 			materialTypeCode: materialTypeCode,
				// 			materialTypeName: materialTypeName,
				// 			driverName: driverName,
				// 			driverCardTypeName: driverCardTypeName,
				// 			driverCardId: driverCardId,
				// 			license: license,
				// 			status: status,
				// 			warehouseName: warehouseName,
				// 			reason: reason,
				// 			applyUserName: applyUserName,
				// 			applyTime: applyTime
				// 		}
				// 	});
				// }
				mui.openWindow({
					url: 'approve.html',
					id: "approve",
					extras: {
						data: outdoorId
					}
				})
			};

			function goToDetail(orderNo, applyTime, holderName, driverName, driverCardId, id, status) {
				// mui.openWindow({
				// 	url: 'detail.html',
				// 	id: 'detail',
				// 	extras: {
				// 		orderNo: orderNo,
				// 		applyTime: applyTime,
				// 		holderName: holderName,
				// 		driverName: driverName,
				// 		driverCardId: driverCardId
				// 	}
				// });
				if (status === 3) {
					mui.openWindow({
						url: "end.html",
						id: "outdoorEnd",
						extras: {
							data: id
						}
					});
				} else {
					mui.openWindow({
						url: "add.html",
						id: "outdoorDetail",
						extras: {
							data: id
						}
					});
				}

			};

			// 申请出门证页面
			function toApply() {
				mui.openWindow({
					url: "add.html"
				});
			}

			var flag = true;
			var Page = {
				init: function() {
					var datas = new Object();
					//datas.pageIndex = 1;
					//datas.pageSize = 10;
					datas.criteria = {
						
					};
					datas.order = {direction: "DESC", property: "id"};
					util.pullRefresh({
						source: function() {
							return flag ? "/outdoor/query" : "/outdoor/auditList";
						},
						container: "#refreshContainer",
						domContainer: function() {
							return flag ? "#outdoorList" : "#approveList";
						},
						type: "POST",
						params: datas,
						resultHandler: function(data) {
							$.each(data.data, function() {
								this.statusClass = statusClass[this.statusValue]
							});
							return data;
						},
						down: true,
						up: true,
						template: function() {
							return flag ? "template" : "template2";
						}
					});
					util.hasPermission("outdoor-add",function(result){
						result && $("#btnApply").show();
						!result && $("#btnApply").hide();
					})
				},
				// 重新加载时使用
				// 重新加载时使用
				reload: function() {
					this.backInit();
				},
				backInit: function() {
					util.pullRefreshRequest("down");
				},
				back: function() {
					var wvB = plus.webview.currentWebview(); //获取当前窗口的WebviewObject对象，即B  
					var wvA = wvB.opener(); //获取当前窗口的创建者，即A  
					wvA.evalJS("Page.reload()"); //执行父窗口中的方法  A中的showAG方法  
					wvB.close();
				},
				beforeback: function() {
					var list = plus.webview.currentWebview().opener();
					//refresh是A页面自定义事件
					mui.fire(list, 'refresh');
					//返回true,继续页面关闭逻辑
					return true;
				}
			}


			mui.plusReady(function() {
				Page.init();
				//监听扫码
				$("#scanCode").codeScan({
					cssClass: "container",
					onScan: function(code) {
						code = code.trim()
						var datas = {criteria:{}};
						datas.criteria.orderNo = code;
						util.ajax({
							type: 'post',
							url: "/outdoor/query",
							dataType: 'json',
							data:JSON.stringify(datas),
							contentType: "application/json",
							success: function(data) {
								if(data.data.length){
									var tempObj = data.data[0];
									goToDetail(tempObj.orderNo, tempObj.applyTime, tempObj.holderName, tempObj.driverName, tempObj.driverCardId,
										tempObj.id,tempObj.statusValue);
								}
							},
							error: function(xhr, type, errorThrown) {
								var temp = JSON.parse(xhr.response)
								mui.toast(temp.message);
							}
						});
						//code为出门单号

					}
				});

				$("#outdoor").on("tap", function() {
					flag = true;
					util.pullRefreshRequest("down");
				});
				$("#approve").on("tap", function() {
					flag = false;
					util.pullRefreshRequest("down");
				});
			});
		</script>
	</body>

</html>
