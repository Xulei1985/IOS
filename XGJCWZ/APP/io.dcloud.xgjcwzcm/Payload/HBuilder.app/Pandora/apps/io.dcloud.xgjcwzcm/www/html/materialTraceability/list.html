<!DOCTYPE html>
<html>
	<head>
		<meta charset="utf-8">
		<title>Hello MUI</title>
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../js/mui/css/mui.css" type="text/css" rel="stylesheet" />
		<link rel="stylesheet" href="../../style/weui.css" />
		<link rel="stylesheet" href="../../fonts/iconfont.css" />
		<link rel="stylesheet" href="../../style/style.css" />
		<script src="../../js/flexible.js"></script>
		<script src="../../js/jquery.min.js"></script>
		<script src="../../js/common.js"></script>
	</head>
	<body ontouchstart>
		<header class="pui-header">
			<h1 class="pui-title">物资追溯</h1>
			<input type="hidden" id="codeScan" />
		</header>
		<div class="ui-wrap">
			<div id="refreshContainer" hidden="hidden"></div>
			<div class="tab-content">
				<ul class="mui-table-view">
					<li id="accordionLi" class="mui-table-view-cell mui-collapse mui-active">
						<a class="mui-navigate-right" href="#">搜索</a>
						<div class="mui-collapse-content">
							<form class="mui-input-group">
								<div class="mui-input-row">
									<label>条码：</label>
									<input id="barcode" type="text" placeholder="请输入条码">
								</div>
								<div class="mui-input-row" style="display:none;">
									<label>物料名称：</label>
									<input id="materialName" type="text" placeholder="请输入物料名称">
								</div>
								<div class="mui-input-row">
									<label>仓库：</label>
									<select id="warehouse">

									</select>
								</div>
								<div class="mui-input-row">
									<label>库位：</label>
									<select id="warehouseLocation">

									</select>
								</div>
								<div class="mui-input-row">
									<label>事件：</label>
									<select id="eventCode" class="mui-btn-block">
										<option value="">请选择事件</option>
										<option value="0">保存</option>
										<option value="1">打印</option>
										<option value="2">入库</option>
										<option value="3">出库</option>
									</select>
								</div>
								<div class="mui-button-row">
									<button id="accordionButton" class="mui-btn mui-btn-primary" type="button" onclick="shrinkAccordion()">确认</button>&nbsp;&nbsp;
								</div>
							</form>
						</div>
					</li>
				</ul>
			</div>
			<div class="tab-content">
				<h4>搜索结果(共计<span id="count">0</span>条)</h4>
			</div>
			<div class="tab-content">
				<div class="tab-pane active" id="materialTraceabilityList">
					<script type="text/html" id="listTemplate">
						<%for(var i=0;i<data.length;i++){%>
							<div class="weui-cell__bd" style="padding-left:10px;border-bottom:1px solid #EAEAEA">
								<div class="qk-text">条码：<%=data[i].barcode%></div>
								<div class="qk-text">单号：<%=data[i].orderNo%></div>
								<div class="qk-text">物料名称：<%=data[i].materialName%></div>
								<div class="qk-text">物料编码：<%=data[i].materialCode%></div>
								<div class="qk-text">所属仓库：<%=data[i].warehouseName%></div>
								<div class="qk-text">物料数量：<%=data[i].materialCount%></div>
								<div class="qk-text">事件：<%=data[i].eventCode%></div>
								<div class="qk-text">库位：<%=data[i].warehouseLocationName%></div>
								<div class="qk-text">创建时间：<%=data[i].createTime%></div>
							</div>
							<br>
						</div> 
						<%}%>
					</script>
				</div>
			</div>
		</div>
		<script type="text/javascript" src="../../js/plugins/jquery-2.1.1.min.js"></script>

		<script type="text/javascript" src="../../js/mui/js/mui.js"></script>
		<script type="text/javascript" src="../../js/plugins/zepto.min.js"></script>
		<script type="text/javascript" src="../../js/plugins/template.js"></script>
		<script type="text/javascript" src="../../js/util.js"></script>
		<script type="text/javascript" src="../../js/codescan/jquery.code-scan.js"></script>
		<script type="text/javascript" src="../../js/control.js"></script>

		<script type="text/javascript">
			function openWindowAndData(keyId, label, name, createLoginName, startTime, total_time, audit_reason, auditTime,
				auditor, auditStatus, createLoginName, deptName) {
				mui.openWindow({
					url: 'detail.html',
					id: 'detail.html',
					extras: {
						keyId: keyId,
						label: label,
						name: name,
						createLoginName: createLoginName,
						startTime: startTime,
						total_time: total_time,
						audit_reason: audit_reason,
						auditTime: auditTime,
						auditor: auditor,
						auditStatus: auditStatus,
						createLoginName: createLoginName,
						deptName: deptName
					}
				});
			};

			function shrinkAccordion() {
				$("#accordionLi").removeClass("mui-active")
				var barcode = $("#barcode").val()
				var materialName = $("#materialName").val()
				var warehouseCode = $("#warehouse").val()
				var warehouseLocationCode = $("#warehouseLocation").val()
				var eventCode = $("#eventCode").val()
				var criteria = {
					barcode: barcode,
					materialName: materialName,
					warehouseCode: warehouseCode,
					warehouseLocationCode:warehouseLocationCode,
					eventCode: eventCode
				}
				var query = {
					criteria: criteria,
					pageIndex: 1,
					pageSize: 10
				}
				util.ajax({
					type: 'post',
					url: '/barcodeLog/query',
					data: query,
					contentType: "application/json;charset=UTF-8",
					success: function(data) {
						var list = {
							data: data.data
						}
						$("#materialTraceabilityList").html(template("listTemplate", list))
						$("#count").html(data.total)
					}
				})
			}

			var Page = {
				init: function() {
					var that = this;
					$("#warehouse").on("change",function(){
						var code = $(this).val();
						that.getWarehouseLocation(code);
					});
					this.getWarehouse();
				},
				// 重新加载时使用
				reload: function() {
					this.backInit();
				},
				backInit: function() {
					util.pullRefreshRequest("down");
				},
				getWarehouse:function(){
					var that  = this;
					util.ajax({
						url:'/warehouse/list',
						success:function(data){
							var html=['<option>选择仓库</option>'];
							that.warehouseData = data;
							$.each(data,function(){
								html.push('<option value="'+this.code+'">'+this.code+"-"+this.name+'</option>');
							})
							$("#warehouse").html(html.join(""));
							var cache = control.getWarehouseCache();
							if(cache){
								$("#warehouse").val(cache.code).trigger("change");
							}
						}
					})
				},
				getWarehouseLocation:function(code){
					var that = this;
					util.ajax({
						url:"/warehouseLocation/"+code+"/list",
						success:function(data){
							that.warehouseLocationData = data;
							var html=['<option>选择库位</option>'];
							$.each(data,function(){
								html.push('<option value="'+this.code+'">'+this.code+"-"+this.name+'</option>');
							})
							$("#warehouseLocation").html(html.join(""));
							var cache = control.getWarehouseLocationCache();
							if(cache){
								$("#warehouseLocation").val(cache.code);
							}
						}
					});
				},

			};
			mui.plusReady(function() {
				Page.init();
				$("#waitTest").on("tap", function() {
					flag = true;
					util.pullRefreshRequest("down");
				});
				$("#hasTest").on("tap", function() {
					flag = false;
					util.pullRefreshRequest("down");
				});
				$("#codeScan").codeScan({
					onScan: function(code) {
						code = code.trim();
						mui.toast(code);
						$("#barcode").val(code);
						shrinkAccordion();
					}
				});
			});
		</script>
	</body>

</html>
