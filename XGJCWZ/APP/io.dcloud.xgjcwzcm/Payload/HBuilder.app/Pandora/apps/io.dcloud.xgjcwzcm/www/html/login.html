<!DOCTYPE html>
<html lang="zh-cmn-Hans">
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=0,viewport-fit=cover">
		<title>登陆</title>
		<link rel="stylesheet" href="../style/weui.css" />
		<link rel="stylesheet" href="../fonts/iconfont.css" />
		<link rel="stylesheet" href="../style/style.css" />
		<script src="../js/flexible.js"></script>
	</head>
	<body ontouchstart>
		<div class="ui-wrap">
			<div class="login-grid">
				<img src="../images/logo.png" alt="" />
			</div>
			<div class="weui-form">
				<div class="weui-cells">
					<div class="weui-cell">
						<div class="iconfont icon-shouji"></div>
						<div class="weui-cell__bd">
							<input class="weui-input" type="text" id="loginName" name="loginName" placeholder="请输入用户名">
						</div>
					</div>
					<div class="weui-cell">
						<div class="iconfont icon-mima"></div>
						<div class="weui-cell__bd">
							<input class="weui-input" type="password" id="password" name="password" placeholder="请输入密码">
						</div>
					</div>
				</div>
				<div class="button-sp-area">
					<a href="javascript:;" class="weui-btn weui-btn_block weui-btn_default">登 录</a>
				</div>
			</div>
		</div>

		<script type="text/javascript" src="../js/plugins/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="../js/mui/js/mui.js"></script>
		<script type="text/javascript" src="../js/util.js"></script>
		<script type="text/javascript" src="../js/plugins/template.js"></script>
		<script type="text/javascript" src="../js/plugins/mainPage.js"></script>
		<script type="text/javascript" src="../js/plugins/update.js"></script>
		<script type="text/javascript">
			$(function() {
				mui.plusReady(function() {
					UserLogin();
					util.appQuit();
					initUser();
					util.androidOpenNotify();
					//alert($(window).height());
				});
			});

			setWinHeight();

			function initUser() {
				var userName = localStorage.getItem("userName");
				if (userName) {
					$("#loginName").val(userName);
				}
			}

			function setWinHeight() {
				//alert(document.documentElement.clientHeight);
				//$(".mui-content").height(document.documentElement.clientHeight);
			};

			function UserLogin() { //用户登录
				$(".weui-btn").on("tap", function() {
					if ($("#loginName").val() == "") {
						event.detail.gesture.preventDefault(); //阻止默认事件
						mui.toast("用户名不能为空");
						mui.focus($("#loginName"));
						return;
					}
					if ($("#password").val() == "") {
						event.detail.gesture.preventDefault();
						mui.toast("密码不能为空");
						mui.focus($("#password"));
						return;
					}
					var datas = new Object();
					datas.username = $("#loginName").val();
					datas.password = $("#password").val();
					datas.clientId = plus.push.getClientInfo().clientid;
					util.ajax({
						url: '/login',
						data: datas,
						needLogin: false,
						contentType: "application/json",
						type: "post",
						success: function(data) {
							if(data.success){
								localStorage.setItem("userName", datas.username);
								util.clearDirectLogin();
								util.setLoginInfo(data.object);
								$("#password").val("");
								plus.webview.currentWebview().close();
								// 登陆成功后，重新加载各预加载页
								var mainWeb = plus.webview.getLaunchWebview();
								mainWeb.reload();
								plus.webview.getWebviewById("materialTraceability").reload();
								plus.webview.getWebviewById("putInStorage").reload();
								plus.webview.getWebviewById("outdoorList").reload();
								//util.pageReload(mainWeb);
								
							}else{
								mui.toast(data.message);
							}
						},
						error: function() {
							mui.toast("登录失败！");
						}
					});
				});
			}
		</script>
	</body>

</html>
