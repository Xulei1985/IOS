<!DOCTYPE html>
<html lang="zh-cmn-Hans">

	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1,maximum-scale=1,user-scalable=no">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		<link href="../../js/mui/css/mui.css" type="text/css" rel="stylesheet" />
		<link rel="stylesheet" href="../../style/weui.css" />
		<link rel="stylesheet" href="../../fonts/iconfont.css" />
		<link rel="stylesheet" href="../../style/style.css" />
		<script src="../../js/flexible.js"></script>

	</head>

	<body ontouchstart>
		<header class="pui-header">
			<h1 class="pui-title">入库</h1>
			<a href="javascript:;" class="pui-icon pull-right" id="btnInWarehouse" style="display:none;">
				<span class="icon-link">扫码入库</span>
			</a>
		</header>
		<div class="ui-wrap">
			<div id="refreshContainer" hidden="hidden"></div>
			<div class="site-tabs">
				<ul class="tab-nav">
					<li class="active"><a href="#onOrder" id="onOrderTab" data-toggle="tab">在途物料</a></li>
					<li><a href="#inWarehouse" id="inWarehouseTab" data-toggle="tab">库存明细</a></li>
				</ul>
			</div>
			<div class="tab-content">
				<div class="tab-pane active" id="onOrder">
				</div>
				<div class="tab-pane" id="inWarehouse">
				</div>
			</div>
		</div>
		<script type="text/html" id="template">
			<%for(var i=0;i<data.length;i++){%>
			<a href="javascript:;" class="weui-cell weui-cell_access">
				<div class="weui-cell__bd">
					<div class="qk-header justify">
						<div class="card-info">条码：<%=data[i].barcode%></div>
					</div>
					<div class="time-div">物料编码：<%=data[i].materialCode%></div>
					<div class="time-div">物料名称：<%=data[i].materialName%></div>
					<div class="time-div">物料数量：<%=data[i].materialCount%></div>
					<div class="time-div">仓库：<%=data[i].warehouseName%></div>
					<div class="time-div">库位：<%=data[i].warehouseLocationName%></div>
					<div class="time-div">创建时间：<%=data[i].createTime%></div>
				</div>
				<div class="">
					<button type="button" class="weui-btn weui-btn_block weui-btn_default confirm-warehouse" 
					style="background-color: white;border: 1px solid green;color:green;line-height:40px;height:40px;" data-barcode=""
					 onclick="inWarehouse('<%=data[i].barcode%>','<%=data[i].materialCount%>')">入库</button>
				</div>
			</a>
			<%}%>
		</script>

		<script type="text/html" id="template2">
			<%for(var i=0;i<data.length;i++){%>
			<a href="javascript:;" onclick="detail('<%=data[i].materialCode%>','<%=data[i].warehouseCode%>','<%=data[i].warehouseLocationCode%>')" class="weui-cell weui-cell_access">
				<div class="weui-cell__bd">
					<div class="qk-header justify">
						<div class="card-info">物料名称：<%=data[i].materialName%></div>
					</div>
					<div class="time-div">物料编码：<%=data[i].materialCode%></div>				
					<div class="time-div">物料数量：<%=data[i].materialCount%></div>
					<div class="time-div">仓库：<%=data[i].warehouseName%></div>
					<div class="time-div">库位：<%=data[i].warehouseLocationName%></div>
				</div><div class="weui-cell__ft"></div>
			</a>
			<%}%>
		</script>
		<script type="text/javascript" src="../../js/plugins/jquery-2.1.1.min.js"></script>
		<script type="text/javascript" src="../../js/plugins/zepto.min.js"></script>
		<script type="text/javascript" src="../../js/mui/js/mui.js"></script>
		<script type="text/javascript" src="../../js/util.js"></script>
		<script type="text/javascript" src="../../js/plugins/template.js"></script>
		<script type="text/javascript" src="../../js/control.js"></script>
		<script src="../../js/common.js"></script>
		<script type="text/javascript">
			var Page = {
				init: function() {
					var that = this;
					util.DEBUG = true;
					this.initEvent();
					var warehouse = control.getWarehouseCache();
					var warehouseLocation = control.getWarehouseLocationCache();
					util.hasPermission("barcode-inwarehouse",function(result){
						if(result){
							$("#btnInWarehouse").show();
							util.pullRefresh({
								source: function() {
									return that.isOnOrder() ? "/barcode/query" : "/barcode/storage";
								},
								container: "#refreshContainer",
								domContainer: function() {
									return that.isOnOrder() ? "#onOrder" : "#inWarehouse";
								},
								type: "POST",
								params: function() {
									return that.isOnOrder() ? {
										criteria: {
											warehouseCode: warehouse && warehouse.code || '',
											warehouseLocationCode: warehouseLocation && warehouseLocation.code || '',
											warehouseStatus: 0
										}
									} : {
										criteria: {
											warehouseCode: warehouse && warehouse.code || '',
											warehouseLocationCode: warehouseLocation && warehouseLocation.code || '',
										}
									}
								},
								resultHandler: function(data) {
									return data;
								},
								down: true,
								up: true,
								template: function() {
									return that.isOnOrder() ? "template" : "template2";
								}
							})
						}else{
							$("#btnInWarehouse").hide();
							util.pullRefresh({
								source: function() {
									return that.isOnOrder() ? "/barcode/query" : "/barcode/storage";
								},
								container: "#refreshContainer",
								domContainer: function() {
									return that.isOnOrder() ? "#onOrder" : "#inWarehouse";
								},
								type: "POST",
								params: function() {
									return that.isOnOrder() ? {
										criteria: {
											warehouseCode: warehouse && warehouse.code || '',
											warehouseLocationCode: warehouseLocation && warehouseLocation.code || '',
											warehouseStatus: 0
										}
									} : {
										criteria: {
											warehouseCode: warehouse && warehouse.code || '',
											warehouseLocationCode: warehouseLocation && warehouseLocation.code || '',
										}
									}
								},
								resultHandler: function(data) {
									return data;
								},
								down: true,
								up: true,
								template: function() {
									return that.isOnOrder() ? "" : "template2";
								}
							})
						}
					})
					

				},
				initEvent: function() {
					var that = this;
					$(".tab-nav").on("tap", "li", function() {
						setTimeout(function() {
							util.pullRefreshRequest("down");
						}, 100);

					});
					
					$("#btnInWarehouse").on("tap", function() {
						mui.openWindow({
							id: "inWarehouse",
							url: "inWarehouse.html"
						})
					});
				},
				isOnOrder: function() {
					return $(".tab-nav li.active a").attr("id") == "onOrderTab";
				},
				reload: function() {
					util.pullRefreshRequest("down");
				}
			}
			mui.plusReady(function() {
				Page.init();
			});

			function inWarehouse(barcode,count){
				var warehouse = control.getWarehouseCache();
				var warehouseLocation = control.getWarehouseLocationCache();
				if (!warehouse || !warehouseLocation) {
					mui.alert("请到我的>基础消息中设置仓库和库位！", "设置提醒");
					return;
				}
				
				util.ajax({
					url: '/barcode/inWarehouse',
					type: "POST",
					data: JSON.stringify({
						barcodeList: [{
							barcode: barcode,
							count: count
						}],
						warehouseCode: warehouse.code,
						warehouseLocationCode: warehouseLocation.code
					}),
					contentType: "application/json",
					success: function(data) {
						if (data && data.success === false) {
							mui.toast(data.message);
						} else {
							mui.toast("入库成功!");
							util.pullRefreshRequest("down");
						}
					}
				})
			}

			function detail(materialCode, warehouseCode, warehouseLocationCode) {
				mui.openWindow({
					url: "detail.html",
					id: "warehouseDetail",
					extras: {
						materialCode: materialCode,
						warehouseCode: warehouseCode,
						warehouseLocationCode: warehouseLocationCode
					}
				});
			}
		</script>
	</body>

</html>
